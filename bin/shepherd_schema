#!/usr/bin/env python

schema="""
create database if not exists shepherd;
use shepherd;

create table apps(
    appid     int unsigned primary key auto_increment,
    appkey    char(32)  not null,
    state     char(16)  not null,
    python    char(255),
    syspath   char(255),
    username  char(64),
    timestamp timestamp
) engine=innodb auto_increment=100000;

create table appnames(
    appname char(64) primary key,
    appid   int unsigned,
    foreign key(appid) references apps(appid)
) engine=innodb;

create table hosts(
    appid       int unsigned not null,
    ip          char(15)     not null,
    count_async int unsigned not null,
    count_sync  int unsigned not null,
    primary key(appid, ip)
) engine=innodb;

create table pools(
    appid int unsigned not null,
    pool  char(32)     not null,
    ip    char(15)     not null,
    primary key(appid, pool, ip)
) engine=innodb;

create table locks(
    sequence   bigint unsigned primary key auto_increment,
    lockname   char(64)        not null,
    appid      int unsigned    not null,
    workerid   bigint unsigned not null,
    unique(lockname, appid, workerid)
) engine=innodb;
create index lock1 on locks(appid, workerid, lockname);

create table workers(
    workerid     bigint unsigned primary key auto_increment,
    appid        int unsigned not null,
    state        char(16)     not null,
    status       longblob,
    continuation longblob,
    session      int unsigned not null default 0,
    created      timestamp default current_timestamp,
    timestamp    timestamp,
    foreign key(appid) references apps(appid)
) engine=innodb;

create table workernames(
    appid      int unsigned not null,
    workername char(64)     not null,
    workerid   bigint unsigned,
    primary key(appid, workername),
    foreign key(workerid) references workers(workerid)
) engine=innodb;

create table messages(
    msgid          bigint unsigned primary key auto_increment,
    appid          int unsigned    not null,
    workerid       bigint unsigned not null,
    senderappid    int unsigned not null,
    senderworkerid bigint unsigned not null,
    pool           char(32) not null default 'default',
    state          char(16) not null,
    lock_ip        char(15),
    priority       tinyint unsigned not null default 128,
    code           char(64) not null,
    data           longblob,
    timestamp      timestamp default current_timestamp
) engine=innodb;

create index msg1 on messages(timestamp, state, lock_ip, appid, pool);
create index msg2 on messages(appid, workerid, msgid);

create table config(
    name  varchar(256) primary key,
    value varchar(256)
) engine=innodb;

create table agentkeys(
    ip  char(15) primary key,
    agentkey char(32)
) engine=innodb;

insert into apps values
    (100001, 'testkey1', 'active','/tmp/abcd/bin/python', null,             null,       null),
    (100002, 'testkey2', 'active','/tmp/abcd/bin/python', null,             'testapp2', null),
    (100003, 'testkey3', 'active','/usr/bin/python',      '/tmp/sheeptest',  null,      null),
    (100004, 'testkey4', 'active','/usr/bin/python',      '/tmp/sheeptest', 'testapp4', null);

insert into appnames values
    ('testapp1',   100001),
    ('testapp2',   100002),
    ('testapp3',   100003),
    ('testapp4',   100004);

insert into hosts values
    (100001, '172.21.205.32', 100, 0),
    (100002, '172.21.205.32', 100, 0),
    (100003, '172.21.205.32', 100, 0),
    (100004, '172.21.205.32', 100, 0);

insert into pools values
    (100001, 'centralbox', '172.21.205.32'),
    (100002, 'centralbox', '172.21.205.32'),
    (100003, 'centralbox', '172.21.205.32'),
    (100004, 'centralbox', '172.21.205.32');

insert into agentkeys values
    ('172.21.205.32', 'somekey');
"""

print(schema)
