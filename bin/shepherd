#!/usr/bin/env python
import os
import sys
import json
import time
import fcntl
import base64
import urllib

def api(resource):
    return json.loads(urllib.urlopen('http://{0}:{1}/{2}'.format(
        sys.argv[2], sys.argv[3], resource)).read())

thread   = sys.argv[1]
sequence = 0
session  = "[%s %s %d" % (thread,
                          time.strftime('%y%m%d%H%M%S', time.gmtime()),
                          os.getpid())


def log(msgORtag, message=None):
    global sequence
    sequence += 1

    utc = time.time()

    if message:
        tag = msgORtag
        msg = message
    else:
        tag = 'LOG'
        msg = msgORtag

    index = msg.find('\n')
    if index > -1:
        tag = 'BLOB'
        msg = base64.b64encode(msg)

    os.write(3, '\n{0} {1} {2}.{3} {4}] : {5}'.format(
        session,
        sequence,
        time.strftime("%y%m%d.%H%M%S", time.gmtime(utc)),
        '%06d' % (int((utc - int(utc)) * 1000000)),
        tag,
        msg))

    return sequence


def ymdH(subtract_hour=0):
    now = int(time.time()) - (subtract_hour*3600)
    return int(time.strftime('%y%m%d%H',time.gmtime((now//(6*3600))*6*3600)))

if thread in ['notifier', 'launcher', 'collector', 'shipper']:
    logseq = ymdH()
    oldseq = ymdH(6)

    os.umask(0077)

    os.closerange(0, 5)

    os.open('/dev/null', os.O_RDONLY)

    for path in ['stdout', 'stderr']:
        os.open('{0}.{1}.{2}'.format(thread, path, logseq),
                os.O_CREAT|os.O_WRONLY|os.O_APPEND,
                0644)

    os.open('log.{0}'.format(logseq), os.O_CREAT|os.O_WRONLY|os.O_APPEND, 0600)

    try:
        fcntl.flock(os.open(thread + '.lock', os.O_CREAT|os.O_RDONLY, 0600),
                    fcntl.LOCK_EX|fcntl.LOCK_NB)
    except:
        log('could not lock file({0})'.format(thread))
        exit(0)

    for path in os.listdir('.'):
        fields = path.split('.')
        if (3 == len(fields)) and (fields[1] in ['stdout', 'stderr']):
            if int(fields[2]) < oldseq:
                os.remove(path)

    module = getattr(__import__('shepherd.' + thread), thread)

    module.conf    = api('config')
    module.log     = log
    module.api     = api
    module.timeout = time.time() + 300

    module.run()
    time.sleep(1)
    os.system(' '.join(sys.argv) + '&')
